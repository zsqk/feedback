# 问题编号 11

> 审核调拨时可以重复被执行.

经查, 在 24 日下午的一次审核调拨中, 用户在很短时间内(至少 1s 内)提交了两次审核请求. 两次审核并行执行, 导致一个调拨单被系统执行了两次.

这个问题可以通过前端或后端解决.

现在希望后端直接杜绝此类问题, 大概方法有两种:

1. 消息队列/单线程/串行
2. 数据库锁

因为前者开发消耗大, 后者在目前架构上更新比较简单, 所以经讨论, 使用后者.

开始希望 PostgreSQL 有一种基于 ID 的事务锁. 如果两个事务持有相同 ID, 则锁冲突.

经查, PostgreSQL 目前没有这种设计.

然后打算采用行锁来达成类似目的.

针对已有数据, 如审核, 这种操作, 是有一条唯一的可锁行的.

参考了非官方中文文档: http://www.postgres.cn/docs/9.6/explicit-locking.html#ROW-LOCK-COMPATIBILITY

经过一系列测试, 该方法是可行的.

目前已部署.

---

总耗时大概 3~5 小时. 三人以上参与.
